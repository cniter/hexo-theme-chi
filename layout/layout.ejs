<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <% let title = page.title; %>
    <title> <% if (title) { %> <%= title %>&nbsp;|&nbsp;<% } %> <%= config.title %> </title>

    <% if (theme.favicon) { %>
        <link rel="icon" href="<%- url_for(theme.favicon) %>"> <!-- 标题栏图标 -->
        <link rel="shortcut icon" href="<%- url_for(theme.favicon) %>">    <!-- 收藏夹图标 -->
    <% } %>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.5/css/fork-awesome.min.css" integrity="sha256-P64qV9gULPHiZTdrS1nM59toStkgjM0dsf5mK/UwBV4=" crossorigin="anonymous" />

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
    <!--网页加载进度条-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js" integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM=" crossorigin="anonymous"></script>
    
    <!--不蒜子网页计数器-->
    <% if (theme.visit_counter) { %>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <% } %>

    <!--gitalk评论系统-->
    <% if (theme.gitalk.on) { %>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.4.1/gitalk.min.css" integrity="sha256-5MJj8IfwScTpk3YXO1VPUpk7u3txgZVw7ekAZdHB4Ks=" crossorigin="anonymous" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.4.1/gitalk.min.js" integrity="sha256-qHkbkGiVGI9wotF374DSGYPPERWwTAxDwXoKCNoZHPk=" crossorigin="anonymous"></script>
    <% } %> 

    <%- css("css/style") %> 

    <% if (theme.cursor.on) { %>
        <%- include('_widget/cursor') %>
    <% } %>
    
    <% if (theme.baidushare.on) { %>
        <script>
            const bdshareURL = "<%= url_for(theme.baidushare.path) %>";
        </script>
    <% } %>
</head>
<body>
    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/css/ie9.css">
        <div class="alert alert-danger topframe" role="alert">
            嘿，朋友！您的浏览器已<strong>过期</strong>，不建议继续食用。
            <a target="_blank" class="alert-link" href="http://browsehappy.com">这里</a> 有些新玩意儿，何不试试？
        </div>
    <![endif]-->
    <header id="header">
        <nav id="navbar" class="navbar navbar-expand-md">
            <div class="container">
                <h1 id="site-title">
                    <a href="<%- url_for() %>" class="navbar-brand">
                        <img src="<%- url_for(theme.favicon) %>">
                        <span><%= config.title %></span>
                    </a>
                </h1>
                <!-- <a id="avatar" class="navbar-brand" href="<%- config.root %>" title="Hi Mate">
                    <img src="<%- url_for(theme.avatar) %>">
                    <span class="author"><%= config.author %></span>
                </a> -->
    
                <button id="navbar-toggler--btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                    <span><i class="fa fa-list-ul" aria-hidden="true"></i></span>
                </button>
    
                <div class="collapse navbar-collapse" id="collapsibleNavbar">
                    <ul class="navbar-nav">
                        <% theme.menu.forEach(function(m) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="<%- url_for(m.url) %>" title="<%- m.intro %>">
                                <i class="<%- m.icon %>"></i>
                                <%= m.title %>
                            </a>
                        </li>
                        <% }) %>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="row">
            <aside id="left-col" class="col-md-1"></aside>
            <main class="col-md-8 col-sm-12">
                <%- body %>
            </main>
            <div id="site-tool">
                <div class="scroll"></div>
                <div class=""></div>
            </div>
            <aside id="right-col" class="col">
                <div id="sidebar">
                    <header class="author-info div-border">
                        <a href="<%- url_for() %>">
                            <img class="header-avatar" src="<%- url_for(theme.avatar) %>">
                        </a>
                        <h1 class="header-author">
                            <a href="<%- url_for() %>" title="Hi Mate">
                                <%= config.author %>
                            </a>
                        </h1>
                        <p class="header-slogan"><%= theme.slogan %></p>
                        <div class="social-info">
                            <% for (let i in theme.social_info){ %>
                                <a class="social-icon" target="_blank" href="<%- url_for(theme.social_info[i]) %>" title="<%= i %>">
                                    <i class="fa fa-<%= i %>" aria-hidden="true"></i>
                                </a>
                            <% } %>
                        </div>
                    </header>
                    <div class="search div-border">
                        <% if (theme.search.on){ %>
                        <form id="search-form">
                            <!-- 搜索框相关 -->
                            <input type="text" id="local-search--input" name="q" results="0" placeholder=" Search..."
                                autocomplete="off" autocorrect="off" />
                            <i class="fa fa-times" onclick="resetSearch()"></i> <!-- 清空/重置搜索框 -->
                        </form>
                        <div id="local-search--result"></div> <!-- 搜索结果区 -->
                        <p class='no-result'>No results found </p> <!-- 无匹配时显示，注意请在 CSS 中设置默认隐藏 -->
                        <% } %>
                    </div>
                </div>
                <div class='toc-card'>
                    <div class="toc-card--head">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </div>
                    <div id="toc" class="toc-card--content">
                        <strong class="toc-title">文章列表</strong>
                        <%- list_posts({amount: 999}) %>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <footer id="footer" class="text-center">
        <div class="copyright-info">
            &copy; 2017 -
            <%= date(new Date(), 'YYYY') %>
            <a href="<%- url_for() %>">
                <%= config.author || config.title %>
            </a>
        </div>
        <% if (theme.visit_counter) { %>
        <span class="site-visitor">
            <i class="fa fa-user-o" aria-hidden="true"></i>
            <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span>
            &nbsp;|&nbsp;
            <i class="fa fa-eye" aria-hidden="true"></i>
            <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span>
            &nbsp;|&nbsp;
            <i class="fa fa-hand-o-up" aria-hidden="true"></i>
            <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
        </span>
        <% } %>
        <div class="site-info">
            <a href="http://hexo.io/" target="_blank">
                Hexo
            </a>
            theme
            <a href="https://github.com/cniter/cniter.github.io" target="_blank">
                chi
            </a>
            by
            <a href="https://github.com/cniter" target="_blank">
                <%= theme.author %>
            </a>
        </div>
    </footer>

    <% if (theme.mathjax){ %>
        <%- include('_widget/mathjax') %>
    <% } %>

    <script type="module" src="<%- url_for('js/main.js') %>"></script>

    <script>
        $(document).ready(function() {
            $('.toc-card').width($('#right-col').width());  // 使目录栏与右侧栏宽度一致
        });
    </script>

<script type="text/javascript">
    // 监听搜索结果是否发生变化
    var MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;  // Firefox和Chrome早期版本中带有前缀
    var target = document.querySelector('#local-search--result');
    var observer = new MutationObserver(function (mutations) {  // 创建观察者对象
        mutations.forEach(function (mutation) {
            console.log(mutation.type); 
            if (!$("#local-search--result").text() && $("#local-search--result").html() != '') {    // 无搜索结果
                $(".no-result").show(200);
            } else {
                $(".no-result").hide();
            }
        });
    });
    var config = { attributes: true, childList: true, characterData: true } // 配置观察选项

    // 激活搜索框时才搜索
    var inputArea = document.querySelector("#local-search--input");
    var getSearchFile = function () {
        // 调用搜索函数
        var search_path = "<%- theme.search.path %>";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
        var path = "<%- url_for() %>" + search_path;
        searchFunc(path, 'local-search--input', 'local-search--result');
        observer.observe(target, config);   // 传入目标节点和观察选项
    }
    inputArea.onfocus = function () { getSearchFile() }

    // 搜索重置
    var $resetButton = $("#search-form .fa-times");
    var $resultArea = $("#local-search--result");
    inputArea.oninput = function () { $resetButton.show(); }
    resetSearch = function () {
        $resultArea.html("");
        document.querySelector("#search-form").reset();
        $resetButton.hide();
        $(".no-result").hide();
        observer.disconnect();  // 停止观察
    }

    // 屏蔽回车
    inputArea.onkeydown = function (event) { if (event.keyCode == 13) return false }

    // 无搜索结果
    // $resultArea.on("DOMNodeRemoved DOMNodeInserted", function (e) {
    //     if (!$(e.target).text()) {
    //         $(".no-result").show(200);
    //     } else {
    //         $(".no-result").hide();
    //     }
    // })

    // 搜索函数
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result--list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var content_index = [];
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title != '' && data_content != '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i == 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='/" + data_url + "' class='search-result--title' target='_blank'>" + "> " + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out characters
                                var start = first_occur - 6;
                                var end = first_occur + 6;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start == 0) {
                                    end = 10;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                })
                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                        }
                    })
                    $resultContent.innerHTML = str;
                })
            }
        })
    }
</script>
</body>
</html>